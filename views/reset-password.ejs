<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head') %>
  <title>Reset Password - Supermarket MVC</title>
</head>
<body class="d-flex flex-column min-vh-100">
  <%- include('partials/navbar') %>
  
  <div class="container mt-5 mb-5">
    <div class="row justify-content-center">
      <div class="col-md-6 col-lg-5">
        <div class="card shadow-sm">
          <div class="card-body p-4">
            <% const isForced = typeof forced !== 'undefined' && forced === 'true'; %>
            <% if (isForced) { %>
              <div class="alert alert-warning">
                <i class="fa fa-exclamation-triangle"></i> 
                <strong>Password Reset Required</strong><br>
                An administrator has required you to reset your password before continuing.
              </div>
            <% } %>
            
            <h3 class="card-title text-center mb-4">Reset Your Password</h3>
            <p class="text-muted text-center mb-4">Enter the code sent to your email and choose a new password.</p>
            
            <form id="reset-password-form">
              <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" name="email" required placeholder="your@email.com">
              </div>
              
              <div class="mb-3">
                <label for="otp" class="form-label">Reset Code (OTP)</label>
                <input type="text" class="form-control" id="otp" name="otp" required maxlength="6" placeholder="6-digit code">
                <small class="text-muted">Enter the 6-digit code from your email</small>
              </div>
              
              <div class="mb-3">
                <label for="newPassword" class="form-label">New Password</label>
                <input type="password" class="form-control" id="newPassword" name="newPassword" required minlength="6" placeholder="At least 6 characters">
              </div>
              
              <div class="mb-3">
                <label for="confirmPassword" class="form-label">Confirm New Password</label>
                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required minlength="6" placeholder="Re-enter password">
              </div>
              
              <div id="error-message" class="alert alert-danger d-none"></div>
              <div id="success-message" class="alert alert-success d-none"></div>
              
              <button type="submit" class="btn btn-primary w-100" id="submit-btn">
                <span id="btn-text">Reset Password</span>
                <span id="btn-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
              </button>
            </form>

            <div class="text-center mt-3">
              <% if (!isForced) { %>
                <a href="/login" class="text-muted me-3">Back to Login</a>
                <a href="/forgot-password" class="text-primary">Resend Code</a>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>

  <script>
    document.getElementById('reset-password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const otp = document.getElementById('otp').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      const errorDiv = document.getElementById('error-message');
      const successDiv = document.getElementById('success-message');
      const submitBtn = document.getElementById('submit-btn');
      const btnText = document.getElementById('btn-text');
      const btnSpinner = document.getElementById('btn-spinner');
      
      // Hide previous messages
      errorDiv.classList.add('d-none');
      successDiv.classList.add('d-none');
      
      // Validate passwords match
      if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match.';
        errorDiv.classList.remove('d-none');
        return;
      }
      
      if (newPassword.length < 6) {
        errorDiv.textContent = 'Password must be at least 6 characters.';
        errorDiv.classList.remove('d-none');
        return;
      }
      
      // Show loading state
      submitBtn.disabled = true;
      btnText.classList.add('d-none');
      btnSpinner.classList.remove('d-none');
      
      try {
        const response = await fetch('/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, otp, newPassword })
        });
        
        const data = await response.json();
        
        if (data.success) {
          successDiv.textContent = data.message;
          successDiv.classList.remove('d-none');
          
          // Redirect to login after 2 seconds
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        } else {
          errorDiv.textContent = data.error || 'Failed to reset password.';
          errorDiv.classList.remove('d-none');
        }
      } catch (error) {
        console.error('Error:', error);
        errorDiv.textContent = 'Failed to reset password. Please try again.';
        errorDiv.classList.remove('d-none');
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        btnText.classList.remove('d-none');
        btnSpinner.classList.add('d-none');
      }
    });
  </script>
</body>
</html>
