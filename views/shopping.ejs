<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/theme.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>Supermarket App</title>
</head>
<body>
    <%- include('partials/navbar') %>

  <div class="container">
    <p>Welcome, <%= user.username %> (<%= user.role %>)</p>
    <br>
    <div class="text-center"><h2>Products from Supermarket</h2></div>
    <br>
    <table class="table table-hover small text-center">
      <thead>
          <tr>
            <th width="100">Product Name</th>
            <th width="100">Product Image</th>
            <th width="50">Quantity</th>
            <th width="50">Price</th>
            <th width="50">Quantity</th>
            <th width="50">Buy</th>
          </tr>
      </thead>
      <tbody>
        <% for(let i=0; i < products.length; i++) { %>
          <tr>
            <td><a href="/product/<%= products[i].id %>" ><%= products[i].productName %></a></td>
            <td><img src = "images/<%= products[i].image %>" width="20%"></td>
            <td><%= products[i].quantity %></td>
            <td>$<%= products[i].price.toFixed(2) %></td>
            <!-- <td>
              <select id="role" name="role" class="form-control" >
                <option value="1" selected >1</option>
                <option value="2" >2</option>
                <option value="3" >3</option>
                <option value="4" >4</option>
                <option value="5" >5</option>
              </select>
            </td> -->
            <!-- Buy Link -->
            <!-- <td><a href="/buyProduct/<%#= products[i].id %>" class="btn btn-primary mt-3">Buy</a></td> -->
            <td>
              <div class="input-group" style="max-width:150px;margin:0 auto;">
                <button class="btn btn-outline-secondary btn-decrement" type="button" data-target="qty-<%= products[i].id %>">-</button>
                <input type="number" step="1" min="1" value="1" id="qty-<%= products[i].id %>" name="quantity" class="form-control qty-input" data-max="<%= products[i].quantity %>">
                <button class="btn btn-outline-secondary btn-increment" type="button" data-target="qty-<%= products[i].id %>">+</button>
              </div>
            </td>

            <td>
                <form action="/add-to-cart/<%= products[i].id %>" method="POST" class="add-to-cart-form">
                  <input type="hidden" name="quantity" value="1" id="hidden-qty-<%= products[i].id %>">
                  <button type="submit" class="btn btn-primary mt-3 btn-add" title="Add to cart"><i class="fa fa-cart-plus"></i></button>
                </form>
            </td>

          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
  <script>
    // small client-side helpers to keep quantity input in sync and clamp to available stock
    document.querySelectorAll('.btn-increment, .btn-decrement').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const targetId = btn.getAttribute('data-target');
        const input = document.getElementById(targetId);
        if (!input) return;
        const max = parseInt(input.getAttribute('data-max'), 10) || 9999;
        let val = parseInt(input.value, 10) || 1;
        if (btn.classList.contains('btn-increment')) val += 1;
        else val -= 1;
        if (val < 1) val = 1;
        if (val > max) val = max;
        input.value = val;
        // update hidden field in the same row (if present)
        const hidden = document.getElementById('hidden-qty-' + targetId.replace('qty-',''));
        if (hidden) hidden.value = val;
      });
    });

    // ensure when numeric input changes manually we clamp and update hidden field
    document.querySelectorAll('.qty-input').forEach(input => {
      input.addEventListener('input', () => {
        const max = parseInt(input.getAttribute('data-max'), 10) || 9999;
        let val = parseInt(input.value, 10) || 1;
        if (val < 1) val = 1;
        if (val > max) val = max;
        input.value = val;
        const id = input.id.replace('qty-','');
        const hidden = document.getElementById('hidden-qty-' + id);
        if (hidden) hidden.value = val;
      });
    });

    // before submitting ensure the form's hidden input holds the current value
    document.querySelectorAll('.add-to-cart-form').forEach(form => {
      form.addEventListener('submit', (e) => {
        const hidden = form.querySelector('input[type=hidden][name=quantity]');
        if (!hidden) return;
        const id = hidden.id.replace('hidden-qty-','');
        const input = document.getElementById('qty-' + id);
        if (input) hidden.value = input.value;
      });
    });
  </script>
  <script src="/js/ui.js"></script>
    <%- include('partials/footer') %>
    <script src="/js/ui.js"></script>
  </body>
</html>
