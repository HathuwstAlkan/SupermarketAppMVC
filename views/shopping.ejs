<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/theme.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>Supermarket MVC</title>
</head>
<body class="d-flex flex-column min-vh-100">
    <%- include('partials/navbar') %>

  <div class="container mt-4 app-main">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">Catalog</h2>
      <div class="d-flex gap-2 align-items-center">
        <input id="catalogSearch" class="form-control form-control-sm" placeholder="Search products..." style="min-width:220px;">
        <select id="catalogCategory" class="form-select form-select-sm" style="max-width:200px;">
          <option value="all">All categories</option>
          <% Object.keys(categories).forEach(cat => { %>
            <option value="<%= cat %>"><%= cat %></option>
          <% }) %>
        </select>
        <select id="catalogBrand" class="form-select form-select-sm" style="max-width:180px;">
          <option value="all">All brands</option>
          <% // gather brands from categories map
             const seenBrands = new Set();
             Object.keys(categories).forEach(cat => categories[cat].forEach(p => { if (p.brand) seenBrands.add(p.brand); }));
             Array.from(seenBrands).forEach(b => { %>
               <option value="<%= b %>"><%= b %></option>
          <% }) %>
        </select>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="filterDeals">
          <label class="form-check-label" for="filterDeals">Deals only</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="filterExpiring">
          <label class="form-check-label" for="filterExpiring">Expiring soon</label>
        </div>
      </div>
    </div>

    <% Object.keys(categories).forEach(cat => { %>
      <section class="category-shelf mb-4">
        <h3 class="mb-2"><%= cat %></h3>
        <div class="shelf position-relative">
          <button class="shelf-nav left btn btn-sm btn-light position-absolute" aria-label="Scroll left">&larr;</button>
          <div class="shelf-row d-flex gap-3 overflow-auto py-2 px-1">
            <% categories[cat].forEach(p => { 
                 // compute expiring flag (bestBefore within 14 days or deal flag)
                 let expiring = false;
                 if (p.bestBefore) {
                   const dd = new Date(p.bestBefore);
                   const now = new Date();
                   const diff = Math.ceil((dd - now) / (1000*60*60*24));
                   if (diff <= 14) expiring = true;
                 }
            %>
              <div class="shelf-item" style="min-width:200px;max-width:200px;" data-brand="<%= p.brand || '' %>" data-deal="<%= p.deal ? 1 : 0 %>" data-expiring="<%= expiring ? 1 : 0 %>">
                <%- include('partials/product-card', { product: p, user: user }) %>
              </div>
            <% }) %>
          </div>
          <button class="shelf-nav right btn btn-sm btn-light position-absolute" aria-label="Scroll right">&rarr;</button>
        </div>
        <div class="mt-2 text-end"><a class="btn btn-link" href="/products/<%= encodeURIComponent(cat) %>">View all <%= cat %></a></div>
      </section>
    <% }) %>
  </div>
  <script>
    // small client-side helpers to keep quantity input in sync and clamp to available stock
    document.querySelectorAll('.btn-increment, .btn-decrement').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const targetId = btn.getAttribute('data-target');
        const input = document.getElementById(targetId);
        if (!input) return;
        const max = parseInt(input.getAttribute('data-max'), 10) || 9999;
        let val = parseInt(input.value, 10) || 1;
        if (btn.classList.contains('btn-increment')) val += 1;
        else val -= 1;
        if (val < 1) val = 1;
        if (val > max) val = max;
        input.value = val;
        // update hidden field in the same row (if present)
        const hidden = document.getElementById('hidden-qty-' + targetId.replace('qty-',''));
        if (hidden) hidden.value = val;
      });
    });

    // ensure when numeric input changes manually we clamp and update hidden field
    document.querySelectorAll('.qty-input').forEach(input => {
      input.addEventListener('input', () => {
        const max = parseInt(input.getAttribute('data-max'), 10) || 9999;
        let val = parseInt(input.value, 10) || 1;
        if (val < 1) val = 1;
        if (val > max) val = max;
        input.value = val;
        const id = input.id.replace('qty-','');
        const hidden = document.getElementById('hidden-qty-' + id);
        if (hidden) hidden.value = val;
      });
    });

    // before submitting ensure the form's hidden input holds the current value
    document.querySelectorAll('.add-to-cart-form').forEach(form => {
      form.addEventListener('submit', (e) => {
        const hidden = form.querySelector('input[type=hidden][name=quantity]');
        if (!hidden) return;
        const id = hidden.id.replace('hidden-qty-','');
        const input = document.getElementById('qty-' + id);
        if (input) hidden.value = input.value;
      });
    });

    // Product detail modal functionality
    let currentProduct = null;

    async function openProductModal(productId) {
      try {
        const resp = await fetch(`/api/products/${productId}`);
        const data = await resp.json();
        if (!data) return alert('Product not found');
        
        currentProduct = data;
        const modal = document.getElementById('productModal');
        const img = document.getElementById('modalProductImage');
        const name = document.getElementById('modalProductName');
        const desc = document.getElementById('modalProductDesc');
        const price = document.getElementById('modalProductPrice');
        const stock = document.getElementById('modalProductStock');
        const category = document.getElementById('modalProductCategory');
        const qtyInput = document.getElementById('modalQty');
        const addToCartBtn = document.getElementById('modalAddToCart');
        const wishlistBtn = document.getElementById('modalAddWishlist');
        
        // Set product details
        img.src = data.image ? `/images/${data.image}` : '/images/misc/no-image.svg';
        img.onerror = function() { this.src = '/images/misc/no-image.svg'; };
        name.textContent = data.productName;
        desc.textContent = data.description || 'No description available.';
        price.textContent = `$${(data.price || 0).toFixed(2)}`;
        stock.textContent = `Available: ${data.quantity}`;
        category.textContent = data.category || 'Uncategorized';
        
        // Stock-based UI
        if (data.quantity <= 0) {
          stock.className = 'text-danger fw-bold';
          stock.textContent = 'Out of Stock';
          qtyInput.disabled = true;
          qtyInput.value = 1;
          addToCartBtn.disabled = true;
          wishlistBtn.style.display = 'inline-block';
        } else {
          stock.className = data.quantity < 10 ? 'text-warning fw-bold' : 'text-success';
          qtyInput.disabled = false;
          qtyInput.max = data.quantity;
          qtyInput.value = 1;
          addToCartBtn.disabled = false;
          wishlistBtn.style.display = 'none';
        }
        
        // Show modal
        new bootstrap.Modal(modal).show();
      } catch (e) {
        console.error('Failed to load product', e);
        alert('Failed to load product details');
      }
    }

    async function addToCartFromModal() {
      if (!currentProduct) return;
      const qty = parseInt(document.getElementById('modalQty').value, 10) || 1;
      
      try {
        const resp = await fetch('/cart/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId: currentProduct.id, quantity: qty })
        });
        const data = await resp.json();
        
        if (data.success) {
          alert(`Added ${qty} ${currentProduct.productName} to cart!`);
          bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
          // Update cart count if exists
          const cartBadge = document.querySelector('#nav-cart-icon .badge');
          if (cartBadge && data.cartCount) cartBadge.textContent = data.cartCount;
        } else {
          alert(data.error || 'Failed to add to cart');
        }
      } catch (e) {
        console.error('Add to cart error', e);
        alert('Failed to add to cart');
      }
    }

    function addToWishlistFromModal() {
      if (!currentProduct) return;
      alert('Wishlist feature coming soon! (Run migration 004 first)');
      // TODO: Implement after running migration 004
    }
  </script>

  <!-- Product Detail Modal -->
  <div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalProductName">Product Name</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-5">
              <img id="modalProductImage" src="" alt="Product" class="img-fluid rounded" style="width:100%;max-height:300px;object-fit:cover;">
            </div>
            <div class="col-md-7">
              <p class="badge bg-secondary mb-2" id="modalProductCategory">Category</p>
              <p id="modalProductDesc" class="mb-3">Description</p>
              <h4 class="mb-2" id="modalProductPrice">$0.00</h4>
              <p id="modalProductStock">Available: 0</p>
              
              <div class="d-flex gap-2 align-items-center mt-3">
                <label for="modalQty" class="form-label mb-0">Quantity:</label>
                <input type="number" id="modalQty" class="form-control" style="width:80px;" min="1" value="1">
                <button id="modalAddToCart" class="btn btn-primary" onclick="addToCartFromModal()">
                  <i class="fa fa-cart-plus"></i> Add to Cart
                </button>
                <button id="modalAddWishlist" class="btn btn-outline-secondary" style="display:none;" onclick="addToWishlistFromModal()">
                  <i class="fa fa-heart"></i> Add to Wishlist
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  </script>
  <%- include('partials/footer') %>
  <script src="/js/ui.js"></script>
  </body>
</html>
