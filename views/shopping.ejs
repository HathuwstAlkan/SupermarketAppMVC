<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/theme.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>Supermarket App</title>
</head>
<body class="d-flex flex-column min-vh-100">
    <%- include('partials/navbar') %>

  <div class="container mt-4 app-main">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">Catalog</h2>
      <div class="d-flex gap-2 align-items-center">
        <input id="catalogSearch" class="form-control form-control-sm" placeholder="Search products..." style="min-width:220px;">
        <select id="catalogCategory" class="form-select form-select-sm" style="max-width:200px;">
          <option value="all">All categories</option>
          <% Object.keys(categories).forEach(cat => { %>
            <option value="<%= cat %>"><%= cat %></option>
          <% }) %>
        </select>
        <select id="catalogBrand" class="form-select form-select-sm" style="max-width:180px;">
          <option value="all">All brands</option>
          <% // gather brands from categories map
             const seenBrands = new Set();
             Object.keys(categories).forEach(cat => categories[cat].forEach(p => { if (p.brand) seenBrands.add(p.brand); }));
             Array.from(seenBrands).forEach(b => { %>
               <option value="<%= b %>"><%= b %></option>
          <% }) %>
        </select>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="filterDeals">
          <label class="form-check-label" for="filterDeals">Deals only</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="filterExpiring">
          <label class="form-check-label" for="filterExpiring">Expiring soon</label>
        </div>
      </div>
    </div>

    <% Object.keys(categories).forEach(cat => { %>
      <section class="category-shelf mb-4">
        <h3 class="mb-2"><%= cat %></h3>
        <div class="shelf position-relative">
          <button class="shelf-nav left btn btn-sm btn-light position-absolute" aria-label="Scroll left">&larr;</button>
          <div class="shelf-row d-flex gap-3 overflow-auto py-2 px-1">
            <% categories[cat].forEach(p => { 
                 // compute expiring flag (bestBefore within 14 days or deal flag)
                 let expiring = false;
                 if (p.bestBefore) {
                   const dd = new Date(p.bestBefore);
                   const now = new Date();
                   const diff = Math.ceil((dd - now) / (1000*60*60*24));
                   if (diff <= 14) expiring = true;
                 }
            %>
              <div class="shelf-item" style="min-width:200px;max-width:200px;" data-brand="<%= p.brand || '' %>" data-deal="<%= p.deal ? 1 : 0 %>" data-expiring="<%= expiring ? 1 : 0 %>">
                <%- include('partials/product-card', { product: p, user: user }) %>
              </div>
            <% }) %>
          </div>
          <button class="shelf-nav right btn btn-sm btn-light position-absolute" aria-label="Scroll right">&rarr;</button>
        </div>
        <div class="mt-2 text-end"><a class="btn btn-link" href="/products/<%= encodeURIComponent(cat) %>">View all <%= cat %></a></div>
      </section>
    <% }) %>
  </div>
  <script>
    // small client-side helpers to keep quantity input in sync and clamp to available stock
    document.querySelectorAll('.btn-increment, .btn-decrement').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const targetId = btn.getAttribute('data-target');
        const input = document.getElementById(targetId);
        if (!input) return;
        const max = parseInt(input.getAttribute('data-max'), 10) || 9999;
        let val = parseInt(input.value, 10) || 1;
        if (btn.classList.contains('btn-increment')) val += 1;
        else val -= 1;
        if (val < 1) val = 1;
        if (val > max) val = max;
        input.value = val;
        // update hidden field in the same row (if present)
        const hidden = document.getElementById('hidden-qty-' + targetId.replace('qty-',''));
        if (hidden) hidden.value = val;
      });
    });

    // ensure when numeric input changes manually we clamp and update hidden field
    document.querySelectorAll('.qty-input').forEach(input => {
      input.addEventListener('input', () => {
        const max = parseInt(input.getAttribute('data-max'), 10) || 9999;
        let val = parseInt(input.value, 10) || 1;
        if (val < 1) val = 1;
        if (val > max) val = max;
        input.value = val;
        const id = input.id.replace('qty-','');
        const hidden = document.getElementById('hidden-qty-' + id);
        if (hidden) hidden.value = val;
      });
    });

    // before submitting ensure the form's hidden input holds the current value
    document.querySelectorAll('.add-to-cart-form').forEach(form => {
      form.addEventListener('submit', (e) => {
        const hidden = form.querySelector('input[type=hidden][name=quantity]');
        if (!hidden) return;
        const id = hidden.id.replace('hidden-qty-','');
        const input = document.getElementById('qty-' + id);
        if (input) hidden.value = input.value;
      });
    });
  </script>
  <%- include('partials/footer') %>
  <script src="/js/ui.js"></script>
  </body>
</html>
