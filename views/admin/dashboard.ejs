<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head') %>
  <title>Admin Dashboard - Supermarket App</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .kpi {display:flex; gap:1rem;}
    .kpi .card {flex:1}
    .chart-wrap{display:grid; grid-template-columns:1fr 1fr; gap:1rem}
    @media (max-width:900px){ .chart-wrap{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <%- include('../partials/navbar') %>

  <div class="container mt-4">
    <h2>Analytics</h2>
    <p class="text-muted">Overview of system KPIs and inventory analytics.</p>

    <!-- SPA container: admin.js will render KPIs, charts and lists here -->
    <div id="admin-app"></div>
  </div>

  <script>
    async function loadStats(){
      const res = await fetch('/admin/stats');
      const data = await res.json();
      if (!data.success) return;
      const s = data.data;
      document.getElementById('k-users').textContent = s.totalUsers;
      document.getElementById('k-products').textContent = s.totalProducts;
      document.getElementById('k-orders').textContent = s.totalOrders;
      document.getElementById('k-revenue').textContent = '$' + (Number(s.totalRevenue) || 0).toFixed(2);

      document.getElementById('lowStock').textContent = s.lowStockCount + ' products below stock threshold';

      const labels = s.recentOrders.length ? s.recentOrders.map(r => r.date) : [];
      const revenueData = s.recentOrders.length ? s.recentOrders.map(r => r.total) : [];
      const ordersData = s.recentOrders.length ? s.recentOrders.map(r => r.count) : [];

      const ctxR = document.getElementById('revenueChart').getContext('2d');
      new Chart(ctxR, { type:'bar', data:{ labels, datasets:[{ label:'Revenue', data: revenueData, backgroundColor:'rgba(201,166,107,0.9)' }] }, options:{ responsive:true } });

      const ctxO = document.getElementById('ordersChart').getContext('2d');
      new Chart(ctxO, { type:'line', data:{ labels, datasets:[{ label:'Orders', data: ordersData, borderColor:'rgba(15,76,92,0.9)', fill:false }] }, options:{ responsive:true } });
    }

    document.addEventListener('DOMContentLoaded', loadStats);
  </script>

  <script src="/js/admin.js"></script>

  <%- include('../partials/footer') %>
</body>
</html>
