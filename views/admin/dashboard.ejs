<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head') %>
  <title>Admin Dashboard - Supermarket App</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .kpi {display:flex; gap:1rem;}
    .kpi .card {flex:1}
    .chart-wrap{display:grid; grid-template-columns:1fr 1fr; gap:1rem}
    @media (max-width:900px){ .chart-wrap{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <%- include('../partials/navbar') %>

  <div class="container mt-4">
    <h2>Admin Dashboard</h2>
    <p class="text-muted">Overview of system KPIs and inventory analytics.</p>

    <div class="kpi my-3">
      <div class="card p-3 text-center">
        <h5>Total Users</h5>
        <h3 id="k-users">—</h3>
      </div>
      <div class="card p-3 text-center">
        <h5>Total Products</h5>
        <h3 id="k-products">—</h3>
      </div>
      <div class="card p-3 text-center">
        <h5>Total Orders</h5>
        <h3 id="k-orders">—</h3>
      </div>
      <div class="card p-3 text-center">
        <h5>Total Revenue</h5>
        <h3 id="k-revenue">—</h3>
      </div>
    </div>

    <div class="chart-wrap my-3">
      <div class="card p-3">
        <h6>Revenue (last 7 days)</h6>
        <canvas id="revenueChart" height="160"></canvas>
      </div>
      <div class="card p-3">
        <h6>Orders (last 7 days)</h6>
        <canvas id="ordersChart" height="160"></canvas>
      </div>
    </div>

    <div class="mt-3">
      <h5>Low Stock Alerts</h5>
      <div id="lowStock" class="text-muted">Loading...</div>
    </div>
  </div>

  <script>
    async function loadStats(){
      const res = await fetch('/admin/stats');
      const data = await res.json();
      if (!data.success) return;
      const s = data.data;
      document.getElementById('k-users').textContent = s.totalUsers;
      document.getElementById('k-products').textContent = s.totalProducts;
      document.getElementById('k-orders').textContent = s.totalOrders;
      document.getElementById('k-revenue').textContent = '$' + (Number(s.totalRevenue) || 0).toFixed(2);

      document.getElementById('lowStock').textContent = s.lowStockCount + ' products below stock threshold';

      const labels = s.recentOrders.length ? s.recentOrders.map(r => r.date) : [];
      const revenueData = s.recentOrders.length ? s.recentOrders.map(r => r.total) : [];
      const ordersData = s.recentOrders.length ? s.recentOrders.map(r => r.count) : [];

      const ctxR = document.getElementById('revenueChart').getContext('2d');
      new Chart(ctxR, { type:'bar', data:{ labels, datasets:[{ label:'Revenue', data: revenueData, backgroundColor:'rgba(201,166,107,0.9)' }] }, options:{ responsive:true } });

      const ctxO = document.getElementById('ordersChart').getContext('2d');
      new Chart(ctxO, { type:'line', data:{ labels, datasets:[{ label:'Orders', data: ordersData, borderColor:'rgba(15,76,92,0.9)', fill:false }] }, options:{ responsive:true } });
    }

    document.addEventListener('DOMContentLoaded', loadStats);
  </script>

  <%- include('../partials/footer') %>
</body>
</html>
