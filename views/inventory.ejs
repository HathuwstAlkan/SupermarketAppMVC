<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head') %>
  <title>Inventory - Supermarket MVC</title>
</head>
<body>
  <%- include('partials/navbar') %>

  <div class="container">
    <p>Welcome, <%= user.username %> (<%= user.role %>)</p>
    <br>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div><h2 class="mb-0">Products</h2><small class="text-muted">Manage product catalog</small></div>
      <div class="d-flex gap-2">
        <input id="inv-search" class="form-control form-control-sm" placeholder="Search products by name, brand or category">
        <select id="inv-filter" class="form-select form-select-sm" style="max-width:180px">
          <option value="">All categories</option>
        </select>
      </div>
    </div>

    <table class="table table-hover small text-center" id="inventory-table">
      <thead>
          <tr>
            <th>Product</th>
            <th>Image</th>
            <th>Category</th>
            <th>Brand</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Best Before</th>
            <th>Edit</th>
            <th>Delete</th>
          </tr>
      </thead>
      <tbody>
        <% for(let i=0; i < products.length; i++) { %>
          <tr>
            <td class="text-start"><a href="/product/<%= products[i].id %>"><strong><%= products[i].productName %></strong></a></td>
            <td><img src="/images/<%= products[i].image ? 'products/' + products[i].image : 'misc/no-image.svg' %>" width="64" style="object-fit:cover;border-radius:6px"></td>
            <td><%= products[i].category || 'Uncategorized' %></td>
            <td><%= products[i].brand || '-' %></td>
            <td><%= products[i].quantity %></td>
            <td>$<%= (products[i].price || 0).toFixed(2) %></td>
            <td><%= products[i].bestBefore ? (new Date(products[i].bestBefore)).toISOString().slice(0,10) : (products[i].expiry ? (new Date(products[i].expiry)).toISOString().slice(0,10) : '-') %></td>
            <!-- Edit Link -->
            <td>
              <a class="btn btn-sm btn-outline-secondary" href="/updateProduct/<%= products[i].id %>" title="Edit">
                <i class="fa fa-edit"></i>
              </a>
            </td>
            <!-- Delete Link -->
            <td>
              <form action="/deleteProduct/<%= products[i].id %>" method="GET" onsubmit="return confirm('Are you sure you want to delete this product?')">
                <button class="btn btn-sm btn-outline-danger" title="Delete" type="submit">
                  <i class="fa fa-trash"></i>
                </button>
              </form>
            </td>
          </tr>
        <% } %>
      </tbody>
    </table>
  <script>
    // client-side search and filter for inventory
    (function(){
      const rows = Array.from(document.querySelectorAll('#inventory-table tbody tr'));
      // populate categories
      const cats = Array.from(new Set(rows.map(r => r.cells[2].textContent.trim()))).sort();
      const sel = document.getElementById('inv-filter');
      if(sel){
        cats.forEach(c => { if(c) sel.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`); });
        sel.addEventListener('change', ()=>{
          const v = sel.value.toLowerCase();
          rows.forEach(r=> r.style.display = (!v || r.cells[2].textContent.toLowerCase().includes(v)) ? '' : 'none');
        });
      }
      const input = document.getElementById('inv-search');
      if(input){
        input.addEventListener('input', ()=>{
          const q = input.value.toLowerCase();
          rows.forEach(r=>{
            r.style.display = q === '' || r.textContent.toLowerCase().includes(q) ? '' : 'none';
          });
        });
      }
    })();
  </script>
  </div>
</body>
</html>
