<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head') %>
  <title>Inventory - Supermarket MVC</title>
  <style>
    .stock-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .stock-red { background-color: #dc3545; }
    .stock-yellow { background-color: #ffc107; }
    .stock-green { background-color: #28a745; }
    
    .filters-bar {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .product-img-thumb {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
    }
    
    .category-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
  </style>
</head>
<body>
  <%- include('partials/navbar') %>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Product Inventory</h2>
      <a href="/addProduct" class="btn btn-success">
        <i class="fa fa-plus"></i> Add New Product
      </a>
    </div>

    <!-- Filters Bar -->
    <div class="filters-bar">
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label small mb-1">Search</label>
          <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search products...">
        </div>
        <div class="col-md-2">
          <label class="form-label small mb-1">Category</label>
          <select id="categoryFilter" class="form-select form-select-sm">
            <option value="all">All Categories</option>
            <option value="Fruits & Vegetables">Fruits & Vegetables</option>
            <option value="Dairy & Eggs">Dairy & Eggs</option>
            <option value="Meat & Seafood">Meat & Seafood</option>
            <option value="Bakery">Bakery</option>
            <option value="Beverages">Beverages</option>
            <option value="Snacks & Candy">Snacks & Candy</option>
            <option value="Canned & Packaged Foods">Canned & Packaged Foods</option>
            <option value="Frozen Foods">Frozen Foods</option>
            <option value="Personal Care">Personal Care</option>
            <option value="Household">Household</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small mb-1">Stock Level</label>
          <select id="stockFilter" class="form-select form-select-sm">
            <option value="all">All Stock Levels</option>
            <option value="out">Out of Stock (0)</option>
            <option value="low">Low Stock (&lt;25%)</option>
            <option value="ok">Normal Stock</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small mb-1">Sort By</label>
          <select id="sortBy" class="form-select form-select-sm">
            <option value="name-asc">Name (A-Z)</option>
            <option value="name-desc">Name (Z-A)</option>
            <option value="price-asc">Price (Low to High)</option>
            <option value="price-desc">Price (High to Low)</option>
            <option value="stock-asc">Stock (Low to High)</option>
            <option value="stock-desc">Stock (High to Low)</option>
            <option value="category">Category</option>
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button id="clearFilters" class="btn btn-sm btn-outline-secondary w-100">Clear Filters</button>
        </div>
      </div>
    </div>

    <!-- Results count -->
    <div class="mb-2">
      <small class="text-muted">Showing <span id="resultCount">0</span> products</small>
    </div>

    <!-- Products Table -->
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th style="width: 60px;">Image</th>
            <th>Product Name</th>
            <th>Category</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Stock Level</th>
            <th>Brand</th>
            <th style="width: 200px;">Actions</th>
          </tr>
        </thead>
        <tbody id="productsTableBody">
          <% products.forEach(product => { 
            // Calculate stock percentage (assume max stock of 100 for calculation)
            const stockPercent = Math.min(100, (product.quantity / 100) * 100);
            let stockClass = 'stock-green';
            let stockText = 'Normal';
            
            if (product.quantity === 0) {
              stockClass = 'stock-red';
              stockText = 'Out of Stock';
            } else if (product.quantity < 25) {
              stockClass = 'stock-yellow';
              stockText = 'Low Stock';
            }
          %>
            <tr class="product-row" 
                data-name="<%= product.productName.toLowerCase() %>"
                data-category="<%= product.category || 'Other' %>"
                data-price="<%= product.price %>"
                data-stock="<%= product.quantity %>"
                data-brand="<%= (product.brand || '').toLowerCase() %>">
              <td>
                <img src="/images/<%= product.image || 'misc/no-image.svg' %>" 
                     class="product-img-thumb" 
                     alt="<%= product.productName %>"
                     onerror="this.src='/images/misc/no-image.svg'">
              </td>
              <td><strong><%= product.productName %></strong></td>
              <td>
                <span class="badge bg-secondary category-badge"><%= product.category || 'Uncategorized' %></span>
              </td>
              <td>$<%= (product.price || 0).toFixed(2) %></td>
              <td><%= product.quantity %></td>
              <td>
                <span class="stock-indicator <%= stockClass %>"></span>
                <small><%= stockText %></small>
              </td>
              <td><%= product.brand || '-' %></td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <a href="/updateProduct/<%= product.id %>" class="btn btn-primary btn-sm">
                    <i class="fa fa-edit"></i> Edit
                  </a>
                  <a href="/deleteProduct/<%= product.id %>" class="btn btn-danger btn-sm" 
                     onclick="return confirm('Delete <%= product.productName %>?')">
                    <i class="fa fa-trash"></i> Delete
                  </a>
                </div>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <% if (products.length === 0) { %>
      <div class="alert alert-info text-center">
        <i class="fa fa-info-circle"></i> No products in inventory. <a href="/addProduct">Add your first product</a>
      </div>
    <% } %>
  </div>

  <script>
    // Store all rows for filtering
    const allRows = Array.from(document.querySelectorAll('.product-row'));
    
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      const stockFilter = document.getElementById('stockFilter').value;
      const sortBy = document.getElementById('sortBy').value;
      
      // Filter rows
      let visibleRows = allRows.filter(row => {
        const name = row.dataset.name;
        const category = row.dataset.category;
        const stock = parseInt(row.dataset.stock, 10);
        const brand = row.dataset.brand;
        
        // Search filter
        const matchesSearch = !searchTerm || name.includes(searchTerm) || brand.includes(searchTerm);
        
        // Category filter
        const matchesCategory = categoryFilter === 'all' || category === categoryFilter;
        
        // Stock filter
        let matchesStock = true;
        if (stockFilter === 'out') matchesStock = stock === 0;
        else if (stockFilter === 'low') matchesStock = stock > 0 && stock < 25;
        else if (stockFilter === 'ok') matchesStock = stock >= 25;
        
        return matchesSearch && matchesCategory && matchesStock;
      });
      
      // Sort rows
      visibleRows.sort((a, b) => {
        switch(sortBy) {
          case 'name-asc':
            return a.dataset.name.localeCompare(b.dataset.name);
          case 'name-desc':
            return b.dataset.name.localeCompare(a.dataset.name);
          case 'price-asc':
            return parseFloat(a.dataset.price) - parseFloat(b.dataset.price);
          case 'price-desc':
            return parseFloat(b.dataset.price) - parseFloat(a.dataset.price);
          case 'stock-asc':
            return parseInt(a.dataset.stock) - parseInt(b.dataset.stock);
          case 'stock-desc':
            return parseInt(b.dataset.stock) - parseInt(a.dataset.stock);
          case 'category':
            return a.dataset.category.localeCompare(b.dataset.category);
          default:
            return 0;
        }
      });
      
      // Hide all rows first
      allRows.forEach(row => row.style.display = 'none');
      
      // Show and reorder visible rows
      const tbody = document.getElementById('productsTableBody');
      visibleRows.forEach(row => {
        row.style.display = '';
        tbody.appendChild(row);
      });
      
      // Update count
      document.getElementById('resultCount').textContent = visibleRows.length;
    }
    
    // Event listeners
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('stockFilter').addEventListener('change', applyFilters);
    document.getElementById('sortBy').addEventListener('change', applyFilters);
    
    document.getElementById('clearFilters').addEventListener('click', () => {
      document.getElementById('searchInput').value = '';
      document.getElementById('categoryFilter').value = 'all';
      document.getElementById('stockFilter').value = 'all';
      document.getElementById('sortBy').value = 'name-asc';
      applyFilters();
    });
    
    // Initial count
    applyFilters();
  </script>

  <%- include('partials/footer') %>
</body>
</html>
